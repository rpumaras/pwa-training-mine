#!/usr/bin/env node
/* * *  *  * *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  * */
/* Copyright (c) 2018 Mobify Research & Development Inc. All rights reserved. */
/* * *  *  * *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  *  * */

const fileUtils = require('../scripts/file-utils')
const raml = require('raml-1-parser')
const path = require('path')
const {extractRecords} = require('../scripts/raml/extract-records')
const {prepareRecord} = require('../scripts/raml/prepare-record')
const generateRecordFile = require('../scripts/raml/generate-record')

const inputName = process.argv[2] || 'test.raml'
const api = raml.loadApiSync(path.resolve(inputName)).expand()
const types = api.types()

fileUtils.mkdirIfNonexistent('schema')
    .then(() => {
        extractRecords(types)
            .filter((record) => !!record)
            .map(prepareRecord)
            .map(generateRecordFile)
            .map(({filename, text}) => fileUtils.writeFile(path.join('schema', filename), text))
    })
