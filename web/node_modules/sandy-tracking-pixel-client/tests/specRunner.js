require.config({
    'baseUrl': '../',
    'paths': {
        'mocha': 'node_modules/mocha/mocha',
        'chai': 'node_modules/chai/chai',
        'sinon': 'node_modules/sinon/lib/sinon',
        'sandy': 'index',
        // we use the instrumented version to ensure that we have a different
        // closure when we import those variables
        'sandySister': 'index-instrumented'
    }
});

define(function(require) {
    require('mocha'); // side effecty
    mocha.setup('bdd');

    require(['tests/sandy'], function(SandyTests) {
        var runner;
        var failedTests = [];

        if (window.mochaPhantomJS) {
            runner = window.mochaPhantomJS.run();
        } else {
            runner = mocha.run();
        }

        runner.on('end', function() {
            window.mochaResults = runner.stats;
            window.mochaResults.reports = failedTests;
        });

        var logFailure = function(test, err) {
            var flattenTitles = function(test) {
                var titles = [];
                while (test.parent.title) {
                    titles.push(test.parent.title);
                    test = test.parent;
                }
                return titles.reverse();
            };

            failedTests.push({name: test.title, result: false, message: err.message, stack: err.stack, titles: flattenTitles(test) });
        };

        runner.on('fail', logFailure);
    });
});
